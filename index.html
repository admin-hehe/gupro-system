<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gupro - System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');
    body { font-family: 'Roboto', sans-serif; background-color: #f4f4f4; }
    .shopee-orange { background-color: #ee4d2d; }
    .text-shopee { color: #ee4d2d; }
    .hidden { display: none; }
    
    /* Toast Top Center */
    #customToast {
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    #customToast.show { top: 20px; }

    /* Modal Styling */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 5000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal-full { 
      position: fixed; 
      top: 0; left: 0; right: 0; bottom: 0; 
      background: white; 
      z-index: 1000; 
      display: flex; 
      flex-direction: column; 
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen pb-20">

  <div id="alertModal" class="modal-overlay hidden">
    <div class="bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl transform scale-95 transition-transform">
      <div class="w-20 h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl font-bold">!</div>
      <h3 class="text-xl font-black text-gray-800 mb-2">Stok Tidak Cukup</h3>
      <p id="alertMsg" class="text-gray-500 text-sm mb-6 leading-relaxed">Mohon periksa kembali jumlah input Anda.</p>
      <button onclick="closeAlert()" class="w-full py-4 shopee-orange text-white rounded-2xl font-bold shadow-lg shadow-orange-100 uppercase tracking-widest">Mengerti</button>
    </div>
  </div>

  <div id="customToast" class="flex items-center p-4 bg-white rounded-2xl shadow-2xl border-b-4 border-orange-500 min-w-[280px]">
    <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-orange-100 rounded-full text-orange-600">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
    </div>
    <div id="toastMsg" class="ml-3 font-bold text-gray-700 text-sm italic">Data Berhasil Disimpan!</div>
  </div>

  <div id="loadingOverlay" class="fixed inset-0 bg-white/95 z-[9999] flex flex-col items-center justify-center">
    <div class="w-12 h-12 border-4 border-orange-200 border-t-orange-600 rounded-full animate-spin"></div>
    <p class="mt-4 text-orange-600 font-bold text-[10px] uppercase tracking-widest">Sinkronisasi Database...</p>
  </div>

  <nav class="shopee-orange p-4 text-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center px-2">
      <div class="flex flex-col">
        <span class="font-bold text-lg leading-none italic">Gupro - System</span>
        <span class="text-[9px] opacity-80 mt-1 tracking-tighter uppercase font-bold">Stock Management System</span>
      </div>
      <div id="syncStatus" class="text-[9px] bg-red-600 px-2 py-1 rounded-full font-bold">OFFLINE</div>
    </div>
  </nav>

  <div class="container mx-auto p-4 max-w-4xl">
    
    <div class="bg-white rounded-2xl shadow-sm p-1.5 flex gap-1.5 mb-4 border border-gray-200">
      <button onclick="switchMode('ONE_STORE')" id="btnModeStore" class="flex-1 py-3 rounded-xl font-bold text-[10px] transition shopee-orange text-white text-center uppercase tracking-widest">üè™ 1 Toko <br> Multi Item</button>
      <button onclick="switchMode('ONE_ITEM')" id="btnModeItem" class="flex-1 py-3 rounded-lg font-bold text-[10px] transition bg-gray-50 text-gray-400 text-center uppercase tracking-widest">üì¶ 1 Item <br> Multi Toko</button>
    </div>

    <div class="bg-white rounded-2xl shadow-sm p-6 mb-4 border border-gray-100">
      <div class="mb-6">
        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2 tracking-widest">Keterangan (Global)</label>
        <input type="text" id="globalKet" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl outline-none focus:border-orange-500 text-sm transition shadow-inner" placeholder="Contoh: Alokasi Toko / Promo ...">
      </div>

      <div class="mb-6 pb-6 border-b border-dashed border-gray-100">
        <label id="headerLabel" class="block text-[10px] font-bold text-gray-400 uppercase mb-2">Pilih Toko Utama</label>
        <button onclick="openSearchModal()" id="mainSelector" class="w-full flex justify-between items-center p-4 bg-orange-50 border border-orange-100 rounded-2xl text-left hover:bg-orange-100 transition">
          <div class="flex flex-col">
            <span id="selectedText" class="text-gray-400 text-sm font-medium italic">Klik untuk mencari...</span>
            <div id="headerStokInfo" class="mt-2 p-2 bg-white text-orange-600 rounded-lg text-[11px] font-bold hidden border border-orange-200 text-center"></div>
          </div>
          <span class="text-orange-500 text-xl">üîç</span>
        </button>
        <input type="hidden" id="mainValue">
        <input type="hidden" id="mainName">
        <input type="hidden" id="mainStokVal" value="0">
      </div>

      <div id="liveCounterArea" class="hidden mb-6 p-4 bg-blue-50 border border-blue-100 rounded-2xl flex justify-between items-center shadow-sm">
        <span class="text-xs font-bold text-blue-700 uppercase tracking-tighter">Total Qty Input</span>
        <span id="totalQtyDisplay" class="text-xl font-black text-blue-700">0</span>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-left text-sm">
          <thead class="text-gray-400 border-b">
            <tr>
              <th id="colDynamic" class="pb-3 font-bold uppercase text-[10px]">Pilih Item</th>
              <th class="pb-3 font-bold text-center w-24 text-[10px]">QTY</th>
              <th class="pb-3 font-bold text-center w-24 text-[10px]">STOK</th>
              <th class="pb-3 w-8"></th>
            </tr>
          </thead>
          <tbody id="itemRows"></tbody>
        </table>
      </div>

      <button onclick="addRow()" class="mt-8 w-full py-4 rounded-2xl font-bold text-[10px] tracking-widest border-2 border-dashed border-gray-100 text-gray-300 hover:text-shopee hover:border-orange-200 transition">+ Tambah Baris Baru</button>
    </div>

    <button onclick="kirimSemua()" id="btnSubmit" class="w-full shopee-orange text-white py-5 rounded-2xl font-bold shadow-2xl shadow-orange-100 hover:brightness-110 active:scale-95 transition tracking-widest uppercase italic">Simpan Data</button>
  </div>

  <div id="searchModal" class="modal-full hidden">
    <div class="shopee-orange p-4 flex items-center gap-4 shadow-lg">
      <button onclick="closeSearchModal()" class="text-white p-2 text-xl">‚úï</button>
      <input type="text" id="searchInput" oninput="filterSearch()" class="flex-1 p-3 rounded-xl outline-none font-bold shadow-inner" placeholder="Ketik nama atau kode...">
    </div>
    <div id="searchList" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzTAAHiPG667RK07OUtdSCmMQjWcNQEf0NkFMeRS3EZprr38r-URE_olQs-ho8shlXEHg/exec";
    let MASTER_DATA = { toko: [], barang: [] };
    let CURRENT_MODE = "ONE_STORE";
    let TARGET_ROW_EL = null;

    window.onload = async () => {
      try {
        const res = await fetch(WEB_APP_URL + "?action=getData");
        MASTER_DATA = await res.json();
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('syncStatus').innerText = "ONLINE";
        document.getElementById('syncStatus').className = "text-[9px] bg-green-600 px-2 py-1 rounded-full text-white font-bold";
        addRow(); 
      } catch (e) { alert("Database Gagal Dimuat."); }
    };

    function showAlert(msg) {
      document.getElementById('alertMsg').innerText = msg;
      document.getElementById('alertModal').classList.remove('hidden');
    }

    function closeAlert() {
      document.getElementById('alertModal').classList.add('hidden');
    }

    function showToast(msg) {
      const toast = document.getElementById('customToast');
      document.getElementById('toastMsg').innerText = msg;
      toast.classList.add('show');
      setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }

    function switchMode(mode) {
      CURRENT_MODE = mode;
      document.getElementById('btnModeStore').className = mode === 'ONE_STORE' ? "flex-1 py-3 rounded-xl font-bold text-[10px] shopee-orange text-white" : "flex-1 py-3 rounded-lg font-bold text-[10px] bg-gray-50 text-gray-400";
      document.getElementById('btnModeItem').className = mode === 'ONE_ITEM' ? "flex-1 py-3 rounded-xl font-bold text-[10px] shopee-orange text-white" : "flex-1 py-3 rounded-lg font-bold text-[10px] bg-gray-50 text-gray-400";
      document.getElementById('headerLabel').innerText = mode === 'ONE_STORE' ? "Pilih Toko Utama" : "Pilih Barang Utama";
      document.getElementById('colDynamic').innerText = mode === 'ONE_STORE' ? "Pilih Item" : "Pilih Toko";
      document.getElementById('liveCounterArea').style.display = mode === 'ONE_ITEM' ? "flex" : "none";
      document.getElementById('headerStokInfo').classList.add('hidden');
      document.getElementById('itemRows').innerHTML = "";
      document.getElementById('selectedText').innerText = "Klik untuk mencari...";
      document.getElementById('mainValue').value = "";
      document.getElementById('mainStokVal').value = "0";
      document.getElementById('totalQtyDisplay').innerText = "0";
      addRow();
    }

    function addRow() {
      const tbody = document.getElementById('itemRows');
      const row = document.createElement('tr');
      row.className = "border-b last:border-0";
      const isOneStore = (CURRENT_MODE === 'ONE_STORE');
      row.innerHTML = `
        <td class="py-5">
          <button onclick="openSearchModal(this)" class="w-full text-left p-3 bg-gray-50 border border-gray-100 rounded-xl text-[11px] truncate row-selector">Pilih...</button>
          <input type="hidden" class="row-val"><input type="hidden" class="row-name"><input type="hidden" class="row-stok-val" value="0">
        </td>
        <td class="py-5 px-1">
          <input type="number" value="1" min="1" oninput="hitungLive()" class="w-full p-2 border rounded-xl font-bold text-center text-sm row-qty">
        </td>
        <td class="py-5 px-1 text-center font-bold text-orange-600 text-[11px] row-stok-label">
          ${isOneStore ? '0' : '-'}
        </td>
        <td class="py-5 text-right">
          <button onclick="this.parentElement.parentElement.remove(); hitungLive();" class="text-gray-200 hover:text-red-500 transition">‚úï</button>
        </td>
      `;
      tbody.appendChild(row);
    }

    function hitungLive() {
      if (CURRENT_MODE !== 'ONE_ITEM') return;
      let total = 0;
      document.querySelectorAll('#itemRows tr').forEach(row => {
        total += parseInt(row.querySelector('.row-qty').value) || 0;
      });
      const display = document.getElementById('totalQtyDisplay');
      const stokMax = parseInt(document.getElementById('mainStokVal').value) || 0;
      display.innerText = total;
      display.className = total > stokMax ? "text-2xl font-black text-red-600 animate-pulse" : "text-2xl font-black text-blue-700";
    }

    function openSearchModal(el = null) {
      TARGET_ROW_EL = el;
      document.getElementById('searchModal').classList.remove('hidden');
      const sInput = document.getElementById('searchInput');
      sInput.value = "";
      setTimeout(() => sInput.focus(), 150);
      filterSearch();
    }

    function closeSearchModal() { document.getElementById('searchModal').classList.add('hidden'); }

    function filterSearch() {
      const q = document.getElementById('searchInput').value.toLowerCase();
      const listDiv = document.getElementById('searchList');
      listDiv.innerHTML = "";
      let data = (CURRENT_MODE === 'ONE_STORE') ? (TARGET_ROW_EL ? MASTER_DATA.barang : MASTER_DATA.toko) : (TARGET_ROW_EL ? MASTER_DATA.toko : MASTER_DATA.barang);

      data.filter(i => (i.nama||"").toLowerCase().includes(q) || (i.id||i.kode||"").toLowerCase().includes(q)).forEach(i => {
        const div = document.createElement('div');
        div.className = "p-4 bg-gray-50 rounded-2xl border border-gray-100 active:bg-orange-50 active:border-orange-200 transition flex flex-col";
        const val = i.id || i.kode;
        const stokInfo = i.stok !== undefined ? ` | Sisa Stok: ${i.stok}` : "";
        div.innerHTML = `<span class="font-bold text-gray-800">${i.nama}</span><span class="text-[10px] text-gray-400 mt-1 uppercase font-bold tracking-widest">${val}${stokInfo}</span>`;
        div.onclick = () => selectItem(val, i.nama, i.stok || 0);
        listDiv.appendChild(div);
      });
    }

    function selectItem(val, name, stok) {
      if(!TARGET_ROW_EL) {
        document.getElementById('selectedText').innerText = name;
        document.getElementById('selectedText').classList.remove('text-gray-400', 'italic');
        document.getElementById('mainValue').value = val;
        document.getElementById('mainName').value = name;
        document.getElementById('mainStokVal').value = stok;
        if(CURRENT_MODE === 'ONE_ITEM') {
          const infoBox = document.getElementById('headerStokInfo');
          infoBox.innerHTML = `SISA STOK GUDANG: <span class="text-base ml-1 font-black">${stok}</span>`;
          infoBox.classList.remove('hidden');
        }
      } else {
        const p = TARGET_ROW_EL.parentElement;
        const row = p.parentElement;
        TARGET_ROW_EL.innerText = name;
        p.querySelector('.row-val').value = val;
        p.querySelector('.row-name').value = name;
        if (CURRENT_MODE === 'ONE_STORE') {
          p.querySelector('.row-stok-val').value = stok;
          row.querySelector('.row-stok-label').innerText = stok;
        } else {
          row.querySelector('.row-stok-label').innerText = "-";
        }
      }
      closeSearchModal();
      hitungLive();
    }

    async function kirimSemua() {
      const mainVal = document.getElementById('mainValue').value;
      const globalKet = document.getElementById('globalKet').value;
      const rows = document.querySelectorAll('#itemRows tr');
      if(!mainVal) return alert("Pilih data utama!");

      let payload = [];
      let summaryQty = {};

      if(CURRENT_MODE === 'ONE_ITEM') {
        let totalOut = 0;
        rows.forEach(r => totalOut += (parseInt(r.querySelector('.row-qty').value) || 0));
        const stokMax = parseInt(document.getElementById('mainStokVal').value);
        if(totalOut > stokMax) {
          showAlert("Total keluar ("+totalOut+") melebihi stok gudang ("+stokMax+").");
          return;
        }
      }

      let rowValid = true;
      rows.forEach(r => {
        const rowVal = r.querySelector('.row-val').value;
        const rowName = r.querySelector('.row-name').value;
        const qty = parseInt(r.querySelector('.row-qty').value) || 0;
        const stokAwal = parseInt(r.querySelector('.row-stok-val').value) || 0;

        if(rowVal) {
          if (CURRENT_MODE === 'ONE_STORE') {
            if (!summaryQty[rowVal]) summaryQty[rowVal] = { total: 0, stok: stokAwal, nama: rowName };
            summaryQty[rowVal].total += qty;
          }
          payload.push({
            storeId: (CURRENT_MODE === 'ONE_STORE') ? mainVal : rowVal,
            storeName: (CURRENT_MODE === 'ONE_STORE') ? document.getElementById('mainName').value : rowName,
            code: (CURRENT_MODE === 'ONE_STORE') ? rowVal : mainVal,
            product: (CURRENT_MODE === 'ONE_STORE') ? rowName : document.getElementById('mainName').value,
            qty: qty, ket: globalKet
          });
        }
      });

      if (CURRENT_MODE === 'ONE_STORE') {
        for (let code in summaryQty) {
          if (summaryQty[code].total > summaryQty[code].stok) {
            showAlert("Produk '" + summaryQty[code].nama + "' total input (" + summaryQty[code].total + ") melebihi stok (" + summaryQty[code].stok + ")");
            rowValid = false;
            break;
          }
        }
      }

      if(!rowValid || payload.length === 0) return;

      const btn = document.getElementById('btnSubmit');
      btn.disabled = true; btn.innerText = "SEDANG MENYIMPAN DATA...";

      try {
        await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        showToast("Berhasil! Data Berhasil Disimpan");
        setTimeout(() => { location.reload(); }, 2000);
      } catch (e) { alert("Error Server"); btn.disabled = false; }
    }
  </script>
</body>
</html>
